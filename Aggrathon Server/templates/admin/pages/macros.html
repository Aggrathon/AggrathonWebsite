{% from 'macros.html' import flash %}

{% macro toolbar(path, newTab=true, showEdit=true) %}
	<div class="btn-group">
		<a target="_blank" href="{{ path }}" class="btn btn-success" title="View Page">
			<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
			<span class="sr-only">View</span>
		</a>
		{% if showEdit %}
		<a target="_blank" href="{{ path }}edit/" class="btn btn-info" title="Edit Page">
			<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
			<span class="sr-only">Edit</span>
		</a>
		{% endif %}
		{% if path != '/' %}
		<button type="button" class="btn btn-default" title="Move Page" onclick="movePage(this);">
			<span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span>
			<span class="sr-only">Move</span>
		</button>
		<button type="button" class="btn btn-default" title="Copy Page" onclick="copyPage(this);">
			<span class="glyphicon glyphicon-duplicate" aria-hidden="true"></span>
			<span class="sr-only">Copy</span>
		</button>
		<button type="button" class="btn btn-danger" title="Delete Page" onclick="deletePage(this);">
			<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
			<span class="sr-only">Delete</span>
		</button>
		{% endif %}
	</div>
{% endmacro %}

{% macro toolbar_list_function(parentTag='tr', contentId='content') %}
	{{ flash(contentId) }}
	<script>
		//Gets the path from an object in the parent
		function getPath(object) {
			return $(object).closest('{{ parentTag }}').find('#path').html();
		}
		//Asks the user for a new path (returns null if new path is wrong)
		function promptNewPath(question, oldpath) {
			var newpath = prompt(question, oldpath);
			if (newpath == null)
				return null;
			if (newpath.charAt(newpath.length - 1) != '/') {
				newpath += '/';
			}
			if (newpath == oldpath) {
				flash("Same path, nothing has changed", "warning");
				return null;
			}
			if (newpath.indexOf('/pages/') != 0) {
				flash("A page must have a path beginning with '/pages/'", "warning");
				return null;
			}
			return newpath;
		}

		function deletePage(object) {
			path = getPath(object);
			if (confirm("Delete page at '" + path + "'?")) {
				$.post('/admin/pages/edit/',
					{ page: path, action: "delete" },
					function (data, status) {
						if (status == 'success') {
							$(object).closest('{{ parentTag }}').remove();
							flash("Page at '" + path + "' deleted", "success");
						} else {
							flash("Page at '" + path + "' could not be deleted\nCause: " + status, "danger");
						}
					});
			}
		}
		function movePage(object) {
			path = getPath(object);
			var newpath = promptNewPath("New path for the page (must begin with '/pages/')", path);
			if (newpath != null) {
				$.post('/admin/pages/edit/',
					{ page: path, action: "move", target: newpath },
					function (data, status) {
						if (status == 'success') {
							$(object).closest('{{ parentTag }}').find('#path').html(newpath);
							flash("Page at '" + path + "' moved to '" + newpath + "'", "success");
						} else {
							flash("Page at '" + path + "' could not be moved to '" + newpath + "'\nCause: "+status, "danger");
						}
					});
			}
		}
		function copyPage(object) {
			path = getPath(object);
			var newpath = promptNewPath("Path for the copy (must begin with '/pages/')", path);
			if (newpath != null) {
				$.post('/admin/pages/edit/',
					{ page: path, action: "copy", target: newpath },
					function (data, status) {
						if (status == 'success') {
							var parent = $(object).closest('{{ parentTag }}');
							var clone = parent.clone()
							clone.find('#path').html(newpath);
							clone.find('#featured').html('');
							parent.after(clone);
							flash("Page at '" + path + "' copied to '" + newpath + "'", "success");
						} else {
							flash("Page at '" + path + "' could not be copied to '" + newpath + "'\nCause: " + status, "danger");
						}
					});
			}
		}
	</script>
{% endmacro %}