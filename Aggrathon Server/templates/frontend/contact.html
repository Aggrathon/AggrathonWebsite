{% from 'macros.html' import flash %}
{{ flash() }}
<form method="post" id="contact" name="contact">
	<div class="form-group has-feedback">
		<label for="email" class="control-label">Email address *</label>
		<input type="email" class="form-control" id="email" placeholder="Email" name="email" onchange="checkEmail();" {% if content.data.email %}value="{{ content.data.email }}"{% endif %} />
		<span class="glyphicon form-control-feedback" aria-hidden="true"></span>
	</div>
	<div class="form-group hidden">
		<label for="website" class="control-label">Website</label>
		<input type="url" class="form-control" id="website" placeholder="Leave this empty (This field finds bots)" name="website" />
	</div>
	<div class="form-group has-feedback">
		<label for="subject" class="control-label">Subject *</label>
		<input type="text" class="form-control" id="subject" placeholder="Subject" name="subject" onchange="checkSubject();" {% if content.data.subject %}value="{{ content.data.subject }}" {% endif %} />
		<span class="glyphicon form-control-feedback" aria-hidden="true"></span>
	</div>
	<div class="form-group has-feedback">
		<label for="message" class="control-label">Message *</label>
		<textarea class="form-control" id="message" placeholder="Message" name="message" rows="5" onchange="checkMessage();"> {% if content.data.message %}{{ content.data.message }}{% endif %}</textarea>
		<span class="glyphicon form-control-feedback" aria-hidden="true"></span>
	</div>
	<div class="panel">Insert Captcha here</div>
	<button class="btn btn-primary btn-lg" type="submit" id="submitButton" disabled="disabled" onclick="submitButton(this);">Send Message</button>
	<span class="pull-right">* Required</span>
	<script language="JavaScript" type="text/javascript">
		function submitTimer(left) {
			button = $('button#submitButton');
			if (left < 0) {
				button.attr("disabled", false);
				button.html("Send Message");
			} else {
				button.html("Wait: " + left)
				button.attr("disabled", true);
				left = left -1
				setTimeout(function () { submitTimer(left); }, 1000);
			}
		}
		submitTimer(5);

		function setFieldComplete(field) {
			field.parent().addClass('has-success');
			field.parent().removeClass('has-error');
			field.parent().find('.glyphicon').addClass('glyphicon-ok');
		}
		function setFieldError(field) {
			field.parent().addClass('has-error');
			field.parent().removeClass('has-success');
			field.parent().find('.glyphicon').addClass('glyphicon-remove');
		}

		function checkEmail() {
			var email = $('#email');
			var val = email.val();
			var split = val.split('@');
			if (val != '' && split.length == 2 && split[1].split('.').length > 1) {
				setFieldComplete(email);
				return true;
			} else {
				setFieldError(email);
				return false;
			}
		}
		function checkSubject() {
			var subject = $('#subject');
			var val = subject.val();
			if (val == '' || val == ' ') {
				setFieldError(subject);
				return false;
			} else {
				setFieldComplete(subject);
				return true;
			}
		}
		function checkMessage() {
			var message = $('#message');
			var val = message.html();
			if (val == '' || val == ' ') {
				setFieldError(message);
				return false;
			} else {
				setFieldComplete(message);
				return true;
			}
		}

		function submitButton(button) {
			if (!button.disabled) {
				var complete = true;

				if(!checkEmail())
					complete = false;
				if(!checkSubject())
					complete = false;
				if(!checkMessage())
					complete = false;

				if (complete) {
					return true;
				} else {
					flash('Not all fields are correctly filled in', 'danger');
					submitTimer(3);
				}
			}
			return false;
		}
		{% if content.data.check %}submitButton({disabled:false});{% endif %}
	</script>
</form>